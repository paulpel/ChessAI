from collections.abc import Sequence

import tensorflow as tf

import maia.tf2.lc0_az_policy_map as lc0_az_policy_map


class ApplySqueezeExcitation(tf.keras.layers.Layer):
    def __init__(self, **kwargs):
        super(ApplySqueezeExcitation, self).__init__(**kwargs)
    
    def build(self, input_shape: Sequence[Sequence]):
        self.reshape_size = input_shape[1][1]

    def call(self, inputs: Sequence):
        x = inputs[0]
        excited = inputs[1]
        gammas, betas = tf.split(tf.reshape(excited, [-1, self.reshape_size, 1, 1]), 2, axis=1)
        return tf.nn.sigmoid(gammas) * x + betas

class ApplyPolicyMap(tf.keras.layers.Layer):
    def __init__(self, **kwargs):
        super(ApplyPolicyMap, self).__init__(**kwargs)
        self.fc1 = tf.constant(lc0_az_policy_map.make_map())  

    def call(self, inputs):
        h_conv_pol_flat = tf.reshape(inputs, [-1, 80 * 8 * 8])
        return tf.matmul(h_conv_pol_flat, tf.cast(self.fc1, h_conv_pol_flat.dtype))


def load_model(path):
    model = tf.keras.models.load_model(path, custom_objects={
    'ApplySqueezeExcitation': ApplySqueezeExcitation,
    'ApplyPolicyMap': ApplyPolicyMap
    })
    return model

# # Loading the model with both custom layers
# loaded_model = tf.keras.models.load_model('maia\\tf2\\mymodel2.h5', custom_objects={
#     'ApplySqueezeExcitation': ApplySqueezeExcitation,
#     'ApplyPolicyMap': ApplyPolicyMap
# })
# print("Model loaded successfully!")

# loaded_model.summary()

# # Freeze all layers except the last few
# for layer in loaded_model.layers[:-11]:  # Adjust the index to freeze the desired layers
#     layer.trainable = False

# # Optionally, print the layer trainability to check
# for layer in loaded_model.layers:
#     print(layer.name, layer.trainable)

# loaded_model.compile(
#     optimizer=tf.keras.optimizers.Adam(),
#     loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),
#     metrics=['accuracy']
# )


# input = '''0000000000000000000000000001000000000000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000001000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000000000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000100000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001000000000000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000001000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000000000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000100000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001000000000000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000000000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000100000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001100000000000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000000000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000100000000000000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001000000010000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000000000000100100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000100000000000000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001100000010000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000001000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000100000000000000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001000000011000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000001000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000100000000000000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000000000001000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000001000000011000010000011000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000100000100000000000000 1
# 0000000000000000000000000000000000000000000000000000000000100000 1
# 0000000000000000000000000000000000000000000001000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000001000000 1
# 0000000011100000000001000000000100000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000100000000000000000000000000000000000000000000 1
# 0001000100000000000000000000000000000000000000000000000000000000 1
# 0000100000000000000000000000000000000000000000000000000000000000 1
# 0100000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 0000000000000000000000000000000000000000000000000000000000000000 0
# 0000000000000000000000000000000000000000000000000000000000000000 1
# 1111111111111111111111111111111111111111111111111111111111111111 1'''.split('\n')

# data = [[float(value) for value in element.split(" ")[0]] for element in input]


# # print(len(data))
# # print(len(data[0]))
# # print(data)

# model_data = np.array(data)
# print(model_data.shape)
# model_data = np.expand_dims(model_data, axis=0)
# print(model_data.shape)


# prediction = loaded_model.predict([model_data])

# print(prediction)
